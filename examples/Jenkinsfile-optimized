@Library('jenkins-shared@main') _

pipeline {
    agent { label 'beta' }

    stages {
        stage('Setup') {
            steps {
                script {
                    // Gọi pipelineSetup() - tự động handle:
                    // - Project variables detection
                    // - GitHub permission validation
                    // - Branch protection checking
                    // - User permission checking
                    // - Telegram notification nếu bị block
                    // - Pipeline termination nếu không có quyền
                    pipelineSetup()
                }
            }
        }

        stage('Get Config') {
            steps {
                script {
                    // Tự động sử dụng cached project vars từ pipelineSetup()
                    // Không cần gọi getProjectVars() lại
                    k8sGetConfig()
                }
            }
        }

        stage('Build & Push') {
            steps {
                script {
                    // Tự động sử dụng cached project vars
                    // Tự động check quyền deployment (skip nếu không có quyền)
                    dockerBuildPush()
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    // Tự động sử dụng cached project vars
                    // Tự động check quyền deployment (skip nếu không có quyền)
                    k8sSetImage()
                }
            }
        }
    }

    post {
        success {
            script {
                // Tự động sử dụng cached project vars để tạo success message
                telegramNotify()
            }
        }

        failure {
            script {
                // Tự động sử dụng cached project vars để tạo failure message
                telegramNotify()
            }
        }
    }
}